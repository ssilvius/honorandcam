---
// Photo Gallery component with masonry layout and fullscreen modal
import { Image } from 'astro:assets';
import { readdir } from 'node:fs/promises';
import { join } from 'node:path';

// Dynamically load gallery images at build time
let galleryImages: { src: string; alt: string }[] = [];
try {
  const galleryPath = join(process.cwd(), 'public', 'gallery');
  const files = await readdir(galleryPath);
  
  // Filter for image files (jpg, jpeg, png) and sort them
  const imageFiles = files
    .filter(file => /\.(jpg|jpeg|png)$/i.test(file))
    .sort();
    
  // Create image objects with proper imports for Astro Image optimization
  galleryImages = imageFiles.map((file, index) => ({
    src: `/gallery/${file}`,
    alt: `Wedding photo ${index + 1}`
  }));
    
  console.log(`Found ${galleryImages.length} gallery images:`, imageFiles);
} catch (error) {
  console.warn('Could not read gallery directory:', error);
  galleryImages = [];
}
---

<div class="photo-gallery-container">
  <!-- Masonry Grid -->
  <div id="photo-gallery" class="masonry-grid">
    {galleryImages.map((image) => (
      <div class="masonry-item">
        <img 
          src={`/cdn-cgi/image/width=800,quality=85,format=webp${image.src}`}
          alt={image.alt}
          class="gallery-image"
          loading="lazy"
          data-original-src={image.src}
        />
      </div>
    ))}
  </div>

  <!-- Fullscreen Modal -->
  <div id="photo-modal" class="photo-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <button id="close-modal" class="close-button" aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <img id="modal-image" src="" alt="" class="modal-image" />
    </div>
  </div>
</div>

<script>
  import { gsap } from 'gsap';

  document.addEventListener('DOMContentLoaded', function() {
    const gallery = document.getElementById('photo-gallery');
    const modal = document.getElementById('photo-modal');
    const modalImage = document.getElementById('modal-image') as HTMLImageElement;
    const closeButton = document.getElementById('close-modal');
    const modalBackdrop = modal?.querySelector('.modal-backdrop');
    const galleryImages = document.querySelectorAll('.gallery-image');

    if (!gallery || !modal || !modalImage || !closeButton || !modalBackdrop) {
      console.error('Required gallery elements not found');
      return;
    }

    // Add click handlers to existing gallery images
    galleryImages.forEach((img) => {
      const imageElement = img as HTMLImageElement;
      imageElement.addEventListener('click', () => {
        // For optimized images, we'll use the original source for the modal
        const originalSrc = imageElement.getAttribute('data-original-src') || imageElement.src;
        openModal(originalSrc, imageElement.alt);
      });
      
      // Handle image load errors gracefully
      imageElement.addEventListener('error', () => {
        const parentItem = imageElement.closest('.masonry-item') as HTMLElement;
        if (parentItem) {
          parentItem.style.display = 'none';
        }
      });
    });

    // Open fullscreen modal
    function openModal(imageSrc: string, imageAlt: string): void {
      if (!modal || !modalBackdrop) return;
      
      modalImage.src = imageSrc;
      modalImage.alt = imageAlt;
      
      const modalContent = modal.querySelector('.modal-content');
      if (!modalContent) return;
      
      gsap.set(modal, { display: 'flex' });
      gsap.set([modalBackdrop, modalContent], { opacity: 0 });
      
      gsap.to(modalBackdrop, {
        opacity: 1,
        duration: 0.3,
        ease: "power2.out"
      });
      
      gsap.to(modalContent, {
        opacity: 1,
        duration: 0.3,
        ease: "power2.out",
        delay: 0.1
      });
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    // Close modal
    function closeModal(): void {
      if (!modal || !modalBackdrop) return;
      
      const modalContent = modal.querySelector('.modal-content');
      if (!modalContent) return;
      
      gsap.to(modalBackdrop, {
        opacity: 0,
        duration: 0.3,
        ease: "power2.out"
      });
      
      gsap.to(modalContent, {
        opacity: 0,
        duration: 0.3,
        ease: "power2.out",
        onComplete: () => {
          if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
          }
        }
      });
    }

    // Event listeners
    closeButton.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', closeModal);
    
    // Close on Escape key
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Escape' && modal.style.display !== 'none') {
        closeModal();
      }
    });

    // Animate items in
    gsap.from('.masonry-item', {
      opacity: 0,
      y: 50,
      duration: 0.6,
      stagger: 0.1,
      ease: "power2.out"
    });
  });
</script>

<style>
  .photo-gallery-container {
    position: relative;
  }

  /* Masonry Grid */
  .masonry-grid {
    column-count: 4;
    column-gap: 1rem;
    margin: 0;
  }

  .masonry-item {
    display: inline-block;
    width: 100%;
    margin-bottom: 1rem;
    break-inside: avoid;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .masonry-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .gallery-image {
    width: 100%;
    height: auto;
    display: block;
    cursor: pointer;
    transition: opacity 0.3s ease;
  }

  .gallery-image:hover {
    opacity: 0.9;
  }

  /* Responsive breakpoints */
  @media (max-width: 1024px) {
    .masonry-grid {
      column-count: 3;
    }
  }

  @media (max-width: 768px) {
    .masonry-grid {
      column-count: 2;
    }
  }

  @media (max-width: 480px) {
    .masonry-grid {
      column-count: 1;
    }
  }

  /* Modal Styles */
  .photo-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(40, 71, 56, 0.95);
    backdrop-filter: blur(8px);
  }

  .modal-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .close-button {
    position: absolute;
    top: -3rem;
    right: -3rem;
    width: 3rem;
    height: 3rem;
    background-color: rgba(251, 254, 251, 0.1);
    border: 2px solid rgba(251, 254, 251, 0.2);
    border-radius: 50%;
    color: #FBFEFB;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(4px);
  }

  .close-button:hover {
    background-color: rgba(251, 254, 251, 0.2);
    border-color: rgba(251, 254, 251, 0.4);
    transform: scale(1.1);
  }

  /* Mobile adjustments for close button */
  @media (max-width: 640px) {
    .close-button {
      top: -2rem;
      right: -1rem;
      width: 2.5rem;
      height: 2.5rem;
    }
    
    .photo-modal {
      padding: 1rem;
    }
  }

  /* Loading states */
  .masonry-item {
    opacity: 0;
  }
</style>